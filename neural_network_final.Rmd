---
title: "neural_network_final"
author: "Liam Dao"
date: "12/15/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Setup
```{r import packages, warning = FALSE, message=FALSE}
library(tidyverse)
library(caret)
library(leaps)
library(glmnet)
library(ggplot2)
library(earth)
library(mgcv)
library(ROCR)
library(Cairo)
library(pROC)
library(ROCR)
library(randomForest)
library(xgboost)
library(Ckmeans.1d.dp)
library(pdp)
library(Matrix)
library(gganimate)
library(cowplot)
library(ggridges)
library(repr)
library(gifski)
library(plotly)
library(rpart)
library(rpart.plot)
library(nnet)
library(NeuralNetTools)
library(Metrics)

#turning off warnings
options(warn=-1)

# Set directory
setwd("C:\\Users\\liamd\\Documents\\GitHub\\NFL_Big_Data_Bowl_2022\\data_folder")

# Read in data
train <- read.csv("model train set.csv")
val <- read.csv("model val set.csv")
test <- read.csv("model test set.csv")
```

## Variable Analysis and Data Posturing (Train)
```{r variable analysis}
# Remove def zone variables
train <- train %>% 
  select(-41:-51)

# Any variables with less than 10 values are labeled at categorical (13 because I wanted zone variables to be a factor)
for (i in 1:length(train)) {
  if (length(unique(train[,i])) < 16) {
    train[,i] = as.factor(train[,i])
  }
}

# Filter out NA observations
train = train %>% filter(is.na(train$kickReturnYardage) == 0)

#Getting variable importance from decision tree
fit = rpart(train$kickReturnYardage ~ . , data = train[,c(4:60)])
rpart.plot(fit)
varimp.data = data.frame(fit$variable.importance)
varimp.data$names = as.character(rownames(varimp.data))
varimp.data

# Check columns data types
sapply(train, class) # Dataset contains numeric, integer, and factor variables

# Scale standardize 
for (i in 4:length(train)) {
  if (class(train[,i]) == c('numeric', 'integer')) {
    train[,i] = scale(train[,i])
  }
}

# Using varimp.data output. Cutoff of 700 for fit.variable.importance
var.sel <- varimp.data$names

train2 <- train %>% 
  select(var.sel, kickReturnYardage, X, gameId, playId)

outliers <- boxplot(train2$kickReturnYardage, plot=FALSE)$out
train2['outlier_flag'] <- ifelse(train2$kickReturnYardage %in% outliers, "1", "0")

train2$outlier_flag <- as.factor(train2$outlier_flag)
```

## Data Posturing (Validation)
```{r data posturing (validation)}
# Remove def zone variables
val <- val %>% 
  select(-41:-51)

# Any variables with less than 10 values are labeled at categorical (16 because I wanted zone variables to be a factor)
for (i in 1:length(val)) {
  if (length(unique(val[,i])) < 16) {
    val[,i] = as.factor(val[,i])
  }
}

# Filter out NA observations
val <-  val %>% 
  filter(is.na(val$kickReturnYardage) == 0)

# Scale standardize 
for (i in 4:length(val)) {
  if (class(val[,i]) == c('numeric', 'integer')) {
    val[,i] = scale(val[,i])
  }
}

val$kickReturnYardage <- as.numeric(val$kickReturnYardage)

# Subset variables and flag outliers
val2 <- val %>% 
  select(var.sel, X, kickReturnYardage, gameId, playId)

outliersval <- boxplot(val2$kickReturnYardage, plot=FALSE)$out
val2['outlier_flag'] <- ifelse(val2$kickReturnYardage %in% outliersval, "1", "0")

val2$outlier_flag <- as.factor(val2$outlier_flag)
```

## Data Posturing (test)
```{r data posturing (test)}
# Remove def zone variables
test <- test %>% 
  select(-41:-51)

# Any variables with less than 10 values are labeled at categorical (16 because I wanted zone variables to be a factor)
for (i in 1:length(test)) {
  if (length(unique(test[,i])) < 16) {
    test[,i] = as.factor(test[,i])
  }
}

# Filter out NA observations
test <-  test %>% 
  filter(is.na(test$kickReturnYardage) == 0)

# Scale standardize 
for (i in 4:length(test)) {
  if (class(test[,i]) == c('numeric', 'integer')) {
    test[,i] = scale(test[,i])
  }
}

test$kickReturnYardage <- as.numeric(test$kickReturnYardage)

# Subset variables and flag outliers
test2 <- test %>% 
  select(var.sel, X, kickReturnYardage, gameId, playId)

outlierstest <- boxplot(test2$kickReturnYardage, plot=FALSE)$out
test2['outlier_flag'] <- ifelse(test2$kickReturnYardage %in% outlierstest, "1", "0")

test2$outlier_flag <- as.factor(test2$outlier_flag)
```

## Model Creation
```{r model creation}
set.seed(123)
nn.yard.model <- nnet(kickReturnYardage ~ . -gameId -playId, data = train2, size = 6, decay = .945, linout = TRUE )
```

## Fit on Validation
```{r fit on validation}
nn.yard.val.predict <- predict(nn.yard.model, newdata = val2)

# Calculate RMSE and MAE
val.rmse <- sqrt(mean((nn.yard.val.predict - val2$kickReturnYardage)^2)) # RMSE
val.mae <- mae(val2$kickReturnYardage, nn.yard.val.predict) # MAE
```
> Performance Metrics:
RMSE: 7.93
MAE: 5.93

## Fit on Test
```{r fit on test}
nn.yard.test.predict <- predict(nn.yard.model, newdata = test2)

# Calculate RMSE and MAE
test.rmse <- sqrt(mean((nn.yard.test.predict - test2$kickReturnYardage)^2)) # RMSE
test.mae <- mae(test2$kickReturnYardage, nn.yard.test.predict) # MAE
```
> Performance Metrics:
RMSE: 10.51
MAE: 7.94


############################# TRY WITH ALL DATA ##################################
## Variable Analysis and Data Posturing (Train)
```{r variable analysis}
# Flag Outliers
outliers <- boxplot(train$kickReturnYardage, plot=FALSE)$out
train['outlier_flag'] <- ifelse(train$kickReturnYardage %in% outliers, "1", "0")

train$outlier_flag <- as.factor(train$outlier_flag)
```

## Data Posturing (Validation)
```{r data posturing (validation)}
# Flag outliers
outliersval <- boxplot(val$kickReturnYardage, plot=FALSE)$out
val['outlier_flag'] <- ifelse(val$kickReturnYardage %in% outliersval, "1", "0")

val$outlier_flag <- as.factor(val$outlier_flag)
```

## Data Posturing (test)
```{r data posturing (test)}
# Flag outliers
outlierstest <- boxplot(test$kickReturnYardage, plot=FALSE)$out
test['outlier_flag'] <- ifelse(test$kickReturnYardage %in% outlierstest, "1", "0")

test$outlier_flag <- as.factor(test$outlier_flag)
```

## Model Creation
```{r model creation}
set.seed(123)
nn.yard.model <- nnet(kickReturnYardage ~ . -gameId -playId, data = train, size = 6, decay = .945, linout = TRUE )
```

## Fit on Validation
```{r fit on validation}
nn.yard.val.predict <- predict(nn.yard.model, newdata = val)

# Calculate RMSE and MAE
val.rmse <- sqrt(mean((nn.yard.val.predict - val$kickReturnYardage)^2)) # RMSE
val.mae <- mae(val2$kickReturnYardage, nn.yard.val.predict) # MAE
```
> Performance Metrics:
RMSE: 8.15
MAE: 5.24

## Fit on Test
```{r fit on test}
nn.yard.test.predict <- predict(nn.yard.model, newdata = test)

# Calculate RMSE and MAE
test.rmse <- sqrt(mean((nn.yard.test.predict - test2$kickReturnYardage)^2)) # RMSE
test.mae <- mae(test$kickReturnYardage, nn.yard.test.predict) # MAE
```
> Performance Metrics:
RMSE: 11.51
MAE: 6.99