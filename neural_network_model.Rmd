---
title: "Neural Network Model"
author: "Liam Dao"
date: "12/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Setup
```{r import packages, warning = FALSE, message=FALSE}
library(tidyverse)
library(caret)
library(leaps)
library(glmnet)
library(ggplot2)
library(earth)
library(mgcv)
library(ROCR)
library(Cairo)
library(pROC)
library(ROCR)
library(randomForest)
library(xgboost)
library(Ckmeans.1d.dp)
library(pdp)
library(Matrix)
library(gganimate)
library(cowplot)
library(ggridges)
library(repr)
library(gifski)
library(plotly)
library(rpart)
library(rpart.plot)
library(nnet)
library(NeuralNetTools)

#turning off warnings
options(warn=-1)

# Set directory
setwd("C:\\Users\\liamd\\Documents\\GitHub\\NFL_Big_Data_Bowl_2022\\data_folder")

# Read in data
train <- read.csv("model train set.csv")
val <- read.csv("model val set.csv")
test <- read.csv("model test set.csv")
```

## Variable Analysis
```{r variable analysis}
# Remove def zone variables
train <- train %>% 
  select(-41:-51)

# Any variables with less than 10 values are labeled at categorical (13 because I wanted zone variables to be a factor)
for (i in 1:length(train)) {
  if (length(unique(train[,i])) < 16) {
    train[,i] = as.factor(train[,i])
  }
}

# Filter out NA observations
train = train %>% filter(is.na(train$kickReturnYardage) == 0)

#Getting variable importance from decision tree
fit = rpart(train$kickReturnYardage ~ . , data = train[,c(4:60)])
rpart.plot(fit)
varimp.data = data.frame(fit$variable.importance)
varimp.data$names = as.character(rownames(varimp.data))
varimp.data

# Check columns data types
sapply(train, class) # Dataset contains numeric, integer, and factor variables

# Scale standardize 
for (i in 4:length(train)) {
  if (class(train[,i]) == c('numeric', 'integer')) {
    train[,i] = scale(train[,i])
  }
}
```

## Variable Selection
```{r variable selection}
# Using varimp.data output. Cutoff of 700 for fit.variable.importance
var.sel <- varimp.data$names

train2 <- train %>% 
  select(var.sel, kickReturnYardage, X, gameId, playId)

# Replace empty values with na
train3 <- train2 %>% 
  mutate(returnDirectionActual = ifelse(returnDirectionActual == "", "N/A", returnDirectionActual))

train3 <- train3 %>% 
  mutate(returnDirectionActual = ifelse(returnDirectionActual == "2", "C", 
                                 ifelse(returnDirectionActual == "3", "L", 
                                 ifelse(returnDirectionActual == "4", "R", "N/A"))))
```


## Model Building - Selected Variables
```{r}
# Initial Model
set.seed(12345)
nn.yards <- nnet(kickReturnYardage ~ . -X -gameId -playId, data = train2, size = 5, linout = TRUE )
plotnet(nn.yards)

# Model Tuning
tune_grid <- expand.grid(
  .size = c(3, 4, 5, 6, 7),
  .decay = c(0, 0.5, 1)
)


set.seed(12345)
nn.yards.caret <- train(kickReturnYardage ~ . -X -gameId -playId,
                        data = train2, 
                        method = "nnet", 
                        #metric = "RMSE",
                        tuneGrid = tune_grid,
                        trControl = trainControl(method = 'cv', number = 10),
                        trace = FALSE, 
                        linout = TRUE,
                        MaxNWts = 3000)
tune.results <- as.data.frame(nn.yards.caret$results)

# Get parameters for best RMSE and for best MAE
tune.results[which.min(tune.results$RMSE),]
tune.results[which.min(tune.results$MAE),]
```
> Current Iteration:
Decay: 1, 1
size: 3, 6
RMSE: 9.74, 9.87
MAE: 5.81, 5.79

```{r tuning playground}
# Model Tuning
tune_grid <- expand.grid(
  .size = c(5, 6, 7, 8),
  .decay = seq(.8, 1, by = .01)
)


set.seed(12345)
nn.yards.caret <- train(kickReturnYardage ~ . -X -gameId -playId,
                        data = train2, 
                        method = "nnet", 
                        #metric = "RMSE",
                        tuneGrid = tune_grid,
                        trControl = trainControl(method = 'cv', number = 10),
                        trace = FALSE, 
                        linout = TRUE,
                        MaxNWts = 3000)
tune.results <- as.data.frame(nn.yards.caret$results)

# Get parameters for best RMSE and for best MAE
tune.results[which.min(tune.results$RMSE),]
tune.results[which.min(tune.results$MAE),]
```
> Current Iteration:
Decay: .94, .85
size: 7, 5
RMSE: 9.65, 9.71
MAE: 5.82, 5.63


# Model Building - All Variables
```{r}
# Initial Model
set.seed(12345)
nn.yards <- nnet(kickReturnYardage ~ . -X -gameId -playId, data = train, size = 5, linout = TRUE )
plotnet(nn.yards)

# Model Tuning
tune_grid <- expand.grid(
  .size = c(3, 4, 5, 6, 7),
  .decay = c(0, 0.5, 1)
)


set.seed(12345)
nn.yards.caret <- train(kickReturnYardage ~ . -X -gameId -playId,
                        data = train, 
                        method = "nnet", 
                        #metric = "RMSE",
                        tuneGrid = tune_grid,
                        trControl = trainControl(method = 'cv', number = 10),
                        trace = FALSE, 
                        linout = TRUE,
                        MaxNWts = 3000)
tune.results <- as.data.frame(nn.yards.caret$results)

# Get parameters for best RMSE and for best MAE
tune.results[which.min(tune.results$RMSE),]
tune.results[which.min(tune.results$MAE),]

plotnet(nn.yards.caret)
```
> Current Iteration:
Decay: 1, .5
size: 4, 3
RMSE: 10.09, 10.19
MAE: 6.31, 6.29


## Filter for >0 returns and selected variables
```{r >0 returns and selected variables}
train4 <- train %>% 
  select(var.sel, kickReturnYardage, X, gameId, playId) %>% 
  filter(kickReturnYardage > 0)

# Model Tuning
tune_grid <- expand.grid(
  .size = c(4, 5, 6, 7, 8),
  .decay = seq(.8, 1, by = .01)
)


set.seed(12345)
nn.yards.caret <- train(kickReturnYardage ~ . -X -gameId -playId,
                        data = train2, 
                        method = "nnet", 
                        #metric = "RMSE",
                        tuneGrid = tune_grid,
                        trControl = trainControl(method = 'cv', number = 10),
                        trace = FALSE, 
                        linout = TRUE,
                        MaxNWts = 3000)
tune.results <- as.data.frame(nn.yards.caret$results)

# Get parameters for best RMSE and for best MAE
tune.results[which.min(tune.results$RMSE),]
tune.results[which.min(tune.results$MAE),]
```
> Current Iteration:
Decay: .89
size: 4
RMSE: 9.65
MAE: 5.67

## Remove kickReturnYardage Outliers
```{r remove kickReturnYardage Outliers}
outliers <- boxplot(train2$kickReturnYardage, plot=FALSE)$out

train5 <- train2[-which(train2$kickReturnYardage %in% outliers),]

# Model Tuning
tune_grid <- expand.grid(
  .size = c(2, 3, 4, 5),
  .decay = seq(.74, 1, by = .02)
)


set.seed(12345)
nn.yards.caret <- train(kickReturnYardage ~ . -X -gameId -playId,
                        data = train5, 
                        method = "nnet", 
                        #metric = "RMSE",
                        tuneGrid = tune_grid,
                        trControl = trainControl(method = 'cv', number = 10),
                        trace = FALSE, 
                        linout = TRUE,
                        MaxNWts = 3000)
tune.results <- as.data.frame(nn.yards.caret$results)

# Get parameters for best RMSE and for best MAE
tune.results[which.min(tune.results$RMSE),]
tune.results[which.min(tune.results$MAE),]
```
> Current Iteration:
Decay: .78, 1
size: 2, 2
RMSE: 5.32, 5.35
MAE: 3.99, 3.989 

## Flag for kickReturnYardage Outliers (55 outliers)
```{r flag for kickReturnYardage Outliers}
train6 <- train2
train6['outlier_flag'] <- ifelse(train6$kickReturnYardage %in% outliers, "1", "0")

# Model Tuning
tune_grid <- expand.grid(
  .size = c(6, 7, 8, 9),
  .decay = seq(.94, .98, by = 0.005)
)


set.seed(12345)
nn.yards.caret <- train(kickReturnYardage ~ . -X -gameId -playId,
                        data = train6, 
                        method = "nnet", 
                        #metric = "RMSE",
                        tuneGrid = tune_grid,
                        trControl = trainControl(method = 'cv', number = 10),
                        trace = FALSE, 
                        linout = TRUE,
                        MaxNWts = 3000)
tune.results <- as.data.frame(nn.yards.caret$results)

# Get parameters for best MAE
tune.results[which.min(tune.results$MAE),]
```
> Current Iteration:
Decay: .95
size: 7
RMSE: 6.93
MAE: 4.83