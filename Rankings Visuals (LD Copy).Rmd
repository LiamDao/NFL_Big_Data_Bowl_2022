---
title: "BDB Visuals"
author: "Pranav Ram"
date: "12/28/2021"
output: html_document
---

```{r setup, include=FALSE}
#load libraries
#install.packages("nflfastR")
library(nflfastR)
library(gsisdecoder)
library(ggimage)
library(teamcolors)
library(gt)
library(reactable)
library(reactablefmtr)
```


```{r, include = FALSE}
#Load in Trevor's final ensemble file
full.preds <- read.csv("C:/Users/liamd/Documents/GitHub/NFL_Big_Data_Bowl_2022/data_folder/full preds.csv")
#Drop X column
full.preds = full.preds %>% select(-"X")

#Create new returnTeam column to implement logos
full.preds['returnerTeam'] <- NA
full.preds$returnerTeam <- ifelse(full.preds$possessionTeam == full.preds$homeTeamAbbr, full.preds$visitorTeamAbbr, full.preds$homeTeamAbbr)

#Change all OAK to LV
full.preds$possessionTeam = ifelse(full.preds$possessionTeam == "OAK", "LV", full.preds$possessionTeam)
full.preds$returnerTeam = ifelse(full.preds$returnerTeam == "OAK", "LV", full.preds$returnerTeam)
full.preds$visitorTeamAbbr = ifelse(full.preds$visitorTeamAbbr == "OAK", "LV", full.preds$visitorTeamAbbr)
full.preds$homeTeamAbbr = ifelse(full.preds$homeTeamAbbr == "OAK", "LV", full.preds$homeTeamAbbr)


```


## Testing out reactable package

# First Visual:
- Table for player ranking
```{r Player Ranking, echo = FALSE}

#Find best & worst returners
bestworst1 <- full.preds %>% 
  group_by(returnerId, returnerTeam, punt_returner_player_name) %>%
  summarise(n = n(), actual_yards = mean(kickReturnYardage), expected_yards = mean(ENS_AVGpreds), yards_over_expected = mean(yard_dif)) %>%
  filter(n >= 10) %>%
  arrange(desc(yards_over_expected))

bestworst1$actual_yards <- round(bestworst1$actual_yards, 2)
bestworst1$expected_yards <- round(bestworst1$expected_yards, 2)
bestworst1$yards_over_expected <- round(bestworst1$yards_over_expected, 2)
#trying to get it uniform, can't get it yet, tried this but it messed up the sorting
#bestworst1$yards_over_expected <- format(round(bestworst1$yards_over_expected, 2), nsmall = 2)
# join team logos to dataset
bestworst1 <- bestworst1 %>%
  left_join(teams_colors_logos, by = c('returnerTeam' = 'team_abbr'))
bestworst1 <- bestworst1 %>%
  select(returnerId, returnerTeam, team_logo_espn, punt_returner_player_name, n, actual_yards, expected_yards, yards_over_expected)


#Plot
reactable(
  bestworst1,
  columns = list(
    n = colDef(name = "Returns"),
    returnerTeam = colDef(show = FALSE),
    punt_returner_player_name = colDef(show = FALSE),
    actual_yards = colDef(name = "Avg Actual Yards"),
    expected_yards = colDef(name = "Avg Expected Yards"),
    yards_over_expected = colDef(name = "Avg Yards Over Expected",
                                 cell = data_bars_pos_neg(
                                  bestworst1,
                                  colors = c("#d7191c", "#ffffbf", "#1a9641"),
                                  number_fmt = scales::number_format(accuracy = 0.01))),
    team_logo_espn = colDef(name = "Player", cell = embed_img(bestworst1, label = "punt_returner_player_name")),
    returnerId = colDef(show = FALSE)

  )
)

reactable(
  bestworst1,
  columns = list(
    n = colDef(name = "Returns"),
    returnerTeam = colDef(show = FALSE),
    punt_returner_player_name = colDef(show = FALSE),
    actual_yards = colDef(name = "Avg Actual Yards"),
    expected_yards = colDef(name = "Avg Expected Yards"),
    yards_over_expected = colDef(name = "Avg Yards Over Expected",
                                 cell = color_tiles(
                                  bestworst1,
                                  colors = c("#d7191c", "#ffffbf", "#1a9641"),
                                  number_fmt = scales::number_format(accuracy = 0.01))),
    team_logo_espn = colDef(name = "Player", cell = embed_img(bestworst1, label = "punt_returner_player_name")),
    returnerId = colDef(show = FALSE)

  )
)

#Problems so far
#Might not be able to summarize by team as some returners left their teams midseason:
#see Adam Humphries?

```
Can 100% make this prettier, this is just a base for now. Reactable pacakge has some crazy functionality.
- Conditional Styling
- Logo Addition based on team abbreviation


# Second Visual:
- Table for team ranking getting in position
```{r Cover Team Ranking, echo=FALSE}
#Find best & worst teams with getting in position
coverteam1 <- full.preds %>% 
  group_by(possessionTeam) %>% 
  summarise(n = n(), yards_given_up = mean(kickReturnYardage), yards_expected = mean(ENS_AVGpreds), yards_expected_diff = mean(yard_dif)) %>%
  arrange(yards_expected)
coverteam1$yards_expected <- round(coverteam1$yards_expected, 2)
coverteam1$yards_given_up <- round(coverteam1$yards_given_up, 2)
coverteam1$yards_expected_diff <- round(coverteam1$yards_expected_diff, 2)
# join team logos to dataset
coverteam1 <- coverteam1 %>%
  left_join(teams_colors_logos, by = c('possessionTeam' = 'team_abbr'))
coverteam1 <- coverteam1 %>%
  select(possessionTeam, team_logo_espn, n, yards_given_up, yards_expected, yards_expected_diff)


#Plot
reactable(
  coverteam1,
  columns = list(
    possessionTeam = colDef(show = FALSE),
    n = colDef(name = "Returns"),
    yards_given_up = colDef(name = "Avg Yards Given Up Per Return"),
    yards_expected_diff = colDef(name = "Avg +/-"),
    yards_expected = colDef(name = "Avg Return Yards Expected"),
    team_logo_espn = colDef(name = "Team", cell = embed_img(coverteam1, label = "possessionTeam"))
      )
)
```


# Third Visual:
- Table for team with punt coverage compared to expected
```{r Return Team Ranking, echo = FALSE}
#Find best & worst teams with getting in position
returnteam1 <- full.preds %>% 
  group_by(returnerTeam) %>% 
  summarise(n = n(), actual_return_yards = mean(kickReturnYardage), yards_expected = mean(ENS_AVGpreds), yards_expected_diff = mean(yard_dif)) %>%
  arrange(desc(yards_expected))
returnteam1$yards_expected <- round(returnteam1$yards_expected, 2)
returnteam1$actual_return_yards <- round(returnteam1$actual_return_yards, 2)
returnteam1$yards_expected_diff <- round(returnteam1$yards_expected_diff, 2)
# join team logos to dataset
returnteam1 <- returnteam1 %>%
  left_join(teams_colors_logos, by = c('returnerTeam' = 'team_abbr'))
returnteam1 <- returnteam1 %>%
  select(returnerTeam, team_logo_espn, n, actual_return_yards, yards_expected, yards_expected_diff)

#Plot
reactable(
  returnteam1,
  columns = list(
    returnerTeam = colDef(name = "Team"),
    n = colDef(name = "Returns"),
    actual_return_yards = colDef(name = "Avg Yards Per Return"),
    yards_expected_diff = colDef(name = "Avg +/-"),
    yards_expected = colDef(name = "Avg Return Yards Expected"),
    team_logo_espn = colDef(cell = embed_img())
  )
)

```

# Subset playground 
```{r}
temp_CAR <- full.preds %>% 
  filter(possessionTeam == "CAR") %>% 
  relocate(possessionTeam, .after = last_col()) %>% 
  relocate(gameId, .after = last_col()) %>% 
  relocate(playId, .after = last_col()) %>% 
  relocate(kickReturnYardage, .after = last_col())
```

